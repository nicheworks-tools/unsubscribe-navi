// scripts/fetch-services.mjs
import fs from "fs";
import path from "path";
import * as cheerio from "cheerio";

const __dirname = new URL(".", import.meta.url).pathname;

/**
 * âœ… ä¸»è¦ã‚µãƒ¼ãƒ“ã‚¹ 50ä»¶ä»¥ä¸Šï¼ˆã‚¸ãƒ£ãƒ³ãƒ«åˆ¥ï¼‰
 * id, name, site, cancelPage, keywords[], notes
 */
const targets = [
  // --- å‹•ç”»é…ä¿¡ ---
  { id: "netflix", name: "Netflix", site: "https://www.netflix.com", cancelPage: "https://help.netflix.com/ja/node/407", keywords: ["å‹•ç”»é…ä¿¡"], notes: "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®šâ†’ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€‚" },
  { id: "amazon-prime", name: "Amazonãƒ—ãƒ©ã‚¤ãƒ ", site: "https://www.amazon.co.jp", cancelPage: "https://www.amazon.co.jp/gp/primecentral", keywords: ["é€šè²©", "å‹•ç”»é…ä¿¡"], notes: "ãƒ—ãƒ©ã‚¤ãƒ ä¼šå“¡æƒ…å ±ã‹ã‚‰è§£ç´„ã€‚" },
  { id: "hulu-jp", name: "Huluï¼ˆæ—¥æœ¬ï¼‰", site: "https://www.hulu.jp", cancelPage: "https://help.hulu.jp/hc/ja/articles/360047222553", keywords: ["å‹•ç”»é…ä¿¡"], notes: "ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«â†’ã‚¢ã‚«ã‚¦ãƒ³ãƒˆâ†’å¥‘ç´„ç¢ºèªã€‚" },
  { id: "unext", name: "U-NEXT", site: "https://video.unext.jp", cancelPage: "https://help.unext.jp/guide/detail/cancellation-method", keywords: ["å‹•ç”»é…ä¿¡"], notes: "å¥‘ç´„å†…å®¹ã®ç¢ºèªãƒ»è§£ç´„ãƒšãƒ¼ã‚¸ã‹ã‚‰ã€‚" },
  { id: "disney-plus", name: "ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ãƒ—ãƒ©ã‚¹", site: "https://www.disneyplus.com", cancelPage: "https://help.disneyplus.com/csp?id=csp_article_content&sys_kb_id=cancel", keywords: ["å‹•ç”»é…ä¿¡"], notes: "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®šâ†’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€‚" },
  { id: "abema", name: "ABEMAãƒ—ãƒ¬ãƒŸã‚¢ãƒ ", site: "https://abema.tv", cancelPage: "https://support.abema.tv/hc/ja/articles/360043971551", keywords: ["å‹•ç”»é…ä¿¡"], notes: "Webã‹ã‚‰ã®è§£ç´„ãŒç¢ºå®Ÿã€‚" },
  { id: "d-anime", name: "dã‚¢ãƒ‹ãƒ¡ã‚¹ãƒˆã‚¢", site: "https://animestore.docomo.ne.jp", cancelPage: "https://animestore.docomo.ne.jp/animestore/CF/faq?type=unsubscribe", keywords: ["ã‚¢ãƒ‹ãƒ¡"], notes: "dã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦è§£ç´„ã€‚" },
  { id: "nicovideo", name: "ãƒ‹ã‚³ãƒ‹ã‚³ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ", site: "https://www.nicovideo.jp", cancelPage: "https://secure.nicovideo.jp/secure/cancel", keywords: ["å‹•ç”»"], notes: "æ”¯æ‰•ã„æ–¹æ³•ã”ã¨ã«ç•°ãªã‚‹æ‰‹é †ã€‚" },
  { id: "youtube-premium", name: "YouTube Premium", site: "https://www.youtube.com", cancelPage: "https://support.google.com/youtube/answer/6308278", keywords: ["å‹•ç”»", "éŸ³æ¥½"], notes: "æœ‰æ–™ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ã‹ã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€‚" },
  { id: "rakuten-tv", name: "Rakuten TV", site: "https://tv.rakuten.co.jp", cancelPage: "https://tv.rakuten.co.jp/static/faq/", keywords: ["å‹•ç”»é…ä¿¡"], notes: "å®šé¡è¦‹æ”¾é¡Œã®è§£ç´„ãƒšãƒ¼ã‚¸ã€‚" },

  // --- éŸ³æ¥½ ---
  { id: "spotify", name: "Spotify Premium", site: "https://www.spotify.com", cancelPage: "https://support.spotify.com/jp/article/cancel-premium/", keywords: ["éŸ³æ¥½"], notes: "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆâ†’ãƒ—ãƒ©ãƒ³ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€‚" },
  { id: "apple-music", name: "Apple Music", site: "https://www.apple.com/jp/apple-music/", cancelPage: "https://support.apple.com/ja-jp/HT202039", keywords: ["éŸ³æ¥½"], notes: "Apple IDã®ã‚µãƒ–ã‚¹ã‚¯ç®¡ç†ã‹ã‚‰ã€‚" },
  { id: "amazon-music", name: "Amazon Music Unlimited", site: "https://music.amazon.co.jp", cancelPage: "https://www.amazon.co.jp/music/settings", keywords: ["éŸ³æ¥½"], notes: "è¨­å®šâ†’ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†ã€‚" },
  { id: "line-music", name: "LINE MUSIC", site: "https://music.line.me", cancelPage: "https://help2.line.me/music_ios/web/categoryId/20010227", keywords: ["éŸ³æ¥½"], notes: "åˆ©ç”¨ã‚¹ãƒˆã‚¢ã”ã¨ã«è§£ç´„ã€‚" },
  { id: "awa", name: "AWA", site: "https://awa.fm", cancelPage: "https://awa-support.zendesk.com/hc/ja/articles/360000004521", keywords: ["éŸ³æ¥½"], notes: "ç™»éŒ²ã‚¹ãƒˆã‚¢ã‹ã‚‰è‡ªå‹•æ›´æ–°åœæ­¢ã€‚" },

  // --- ã‚¯ãƒ©ã‚¦ãƒ‰ / ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ---
  { id: "google-one", name: "Google One", site: "https://one.google.com", cancelPage: "https://one.google.com/storage/cancel", keywords: ["ã‚¯ãƒ©ã‚¦ãƒ‰"], notes: "ç®¡ç†ç”»é¢ã‹ã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€‚" },
  { id: "icloud", name: "iCloud+", site: "https://www.icloud.com", cancelPage: "https://support.apple.com/ja-jp/HT207527", keywords: ["ã‚¯ãƒ©ã‚¦ãƒ‰"], notes: "ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ—ãƒ©ãƒ³è¨­å®šã‹ã‚‰ã€‚" },
  { id: "dropbox", name: "Dropbox", site: "https://www.dropbox.com", cancelPage: "https://help.dropbox.com/ja-jp/account-settings/cancel-dropbox-subscription", keywords: ["ã‚¯ãƒ©ã‚¦ãƒ‰"], notes: "ãƒ—ãƒ©ãƒ³è¨­å®šâ†’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€‚" },
  { id: "onedrive", name: "OneDrive", site: "https://www.microsoft.com", cancelPage: "https://account.microsoft.com/services", keywords: ["ã‚¯ãƒ©ã‚¦ãƒ‰"], notes: "ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†ã€‚" },
  { id: "box", name: "Box", site: "https://www.box.com", cancelPage: "https://support.box.com/hc/en-us/articles/360043695534", keywords: ["ã‚¯ãƒ©ã‚¦ãƒ‰"], notes: "è«‹æ±‚æƒ…å ±ã‹ã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€‚" },

  // --- SNS ---
  { id: "twitter-x", name: "Xï¼ˆæ—§Twitterï¼‰", site: "https://x.com", cancelPage: "https://help.x.com/articles/15362", keywords: ["SNS"], notes: "è¨­å®šâ†’ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã€‚" },
  { id: "instagram", name: "Instagram", site: "https://www.instagram.com", cancelPage: "https://www.instagram.com/accounts/remove/request/permanent/", keywords: ["SNS"], notes: "Webå°‚ç”¨å‰Šé™¤ãƒšãƒ¼ã‚¸ã€‚" },
  { id: "facebook", name: "Facebook", site: "https://www.facebook.com", cancelPage: "https://www.facebook.com/help/delete_account", keywords: ["SNS"], notes: "å‰Šé™¤ãƒšãƒ¼ã‚¸ã‹ã‚‰é€€ä¼šã€‚" },
  { id: "line", name: "LINE", site: "https://line.me", cancelPage: "https://help.line.me/line/?contentId=20000262", keywords: ["SNS"], notes: "é€€ä¼šã™ã‚‹ã¨å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã€‚" },
  { id: "tiktok", name: "TikTok", site: "https://www.tiktok.com", cancelPage: "https://support.tiktok.com/ja/account-and-privacy/account-information/how-to-delete-your-account", keywords: ["SNS"], notes: "ã‚¢ãƒ—ãƒªorWebã‹ã‚‰å‰Šé™¤ã€‚" },

  // --- æ±ºæ¸ˆ / é‡‘è ---
  { id: "paypal", name: "PayPal", site: "https://www.paypal.com", cancelPage: "https://www.paypal.com/myaccount/settings/", keywords: ["æ±ºæ¸ˆ"], notes: "è¨­å®šâ†’ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’é–‰é–ã€‚" },
  { id: "rakuten-card", name: "æ¥½å¤©ã‚«ãƒ¼ãƒ‰", site: "https://www.rakuten-card.co.jp", cancelPage: "https://www.rakuten-card.co.jp/support/cancel/", keywords: ["æ±ºæ¸ˆ"], notes: "å•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã€‚" },
  { id: "paypay", name: "PayPay", site: "https://paypay.ne.jp", cancelPage: "https://paypay.ne.jp/help/c0046/", keywords: ["æ±ºæ¸ˆ"], notes: "æ®‹é«˜ã‚¼ãƒ­ã§é€€ä¼šå¯èƒ½ã€‚" },
  { id: "d-card", name: "dã‚«ãƒ¼ãƒ‰", site: "https://d-card.jp", cancelPage: "https://www.docomo.ne.jp/charge/d_card/qa/cancel.html", keywords: ["æ±ºæ¸ˆ"], notes: "dã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§è§£ç´„ã€‚" },
  { id: "aupay-card", name: "au PAY ã‚«ãƒ¼ãƒ‰", site: "https://www.kddi-fs.com", cancelPage: "https://www.kddi-fs.com/faq/card/close.html", keywords: ["æ±ºæ¸ˆ"], notes: "Webã¾ãŸã¯é›»è©±ã€‚" },

  // --- ã‚µãƒ–ã‚¹ã‚¯ / ç”Ÿæ´» ---
  { id: "moneyforward", name: "ãƒãƒãƒ¼ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ ME", site: "https://moneyforward.com", cancelPage: "https://support.me.moneyforward.com/hc/ja/articles/201870394", keywords: ["å®¶è¨ˆç°¿"], notes: "ãƒ—ãƒ¬ãƒŸã‚¢ãƒ è§£ç´„ã¯ã“ã¡ã‚‰ã€‚" },
  { id: "kurashiru", name: "ã‚¯ãƒ©ã‚·ãƒ«", site: "https://www.kurashiru.com", cancelPage: "https://support.kurashiru.com/hc/ja/articles/900004624206", keywords: ["ãƒ¬ã‚·ãƒ”"], notes: "ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³è§£ç´„ã€‚" },
  { id: "cookpad", name: "cookpad", site: "https://cookpad.com", cancelPage: "https://cookpad.com/ct/plus/cancel", keywords: ["ãƒ¬ã‚·ãƒ”"], notes: "æœ‰æ–™ä¼šå“¡ã®è§£ç´„ã€‚" },
  { id: "yahoo-premium", name: "Yahoo!ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ", site: "https://premium.yahoo.co.jp", cancelPage: "https://premium.yahoo.co.jp/cancel/", keywords: ["ç”Ÿæ´»"], notes: "ä¼šå“¡æƒ…å ±ã‹ã‚‰é€€ä¼šã€‚" },
  { id: "rakuten-magazine", name: "æ¥½å¤©ãƒã‚¬ã‚¸ãƒ³", site: "https://magazine.rakuten.co.jp", cancelPage: "https://magazine.rakuten.co.jp/help/", keywords: ["é›‘èªŒ"], notes: "å¥‘ç´„å†…å®¹ã®ç¢ºèªãƒ»å¤‰æ›´ã€‚" },

  // --- ã‚²ãƒ¼ãƒ  ---
  { id: "ps-plus", name: "PlayStation Plus", site: "https://www.playstation.com", cancelPage: "https://www.playstation.com/ja-jp/support/subscriptions/cancel-playstation-plus/", keywords: ["ã‚²ãƒ¼ãƒ "], notes: "ã‚µãƒ–ã‚¹ã‚¯ç®¡ç†ç”»é¢ã‹ã‚‰ã€‚" },
  { id: "switch-online", name: "Nintendo Switch Online", site: "https://www.nintendo.co.jp", cancelPage: "https://www.nintendo.co.jp/support/switch/online/cancel.html", keywords: ["ã‚²ãƒ¼ãƒ "], notes: "ãƒ‹ãƒ³ãƒ†ãƒ³ãƒ‰ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®šã‹ã‚‰ã€‚" },
  { id: "xbox-pass", name: "Xbox Game Pass", site: "https://www.xbox.com", cancelPage: "https://account.microsoft.com/services", keywords: ["ã‚²ãƒ¼ãƒ "], notes: "å®šæœŸè«‹æ±‚ã‹ã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€‚" },
  { id: "steam", name: "Steam", site: "https://store.steampowered.com", cancelPage: "https://help.steampowered.com/ja/faqs/view/2D2C-4A9E-0878-F2D2", keywords: ["ã‚²ãƒ¼ãƒ "], notes: "ã‚µãƒ–ã‚¹ã‚¯è§£é™¤æ–¹æ³•ã‚ã‚Šã€‚" },

  // --- æ—…è¡Œ / äº¤é€š ---
  { id: "jalan", name: "ã˜ã‚ƒã‚‰ã‚“net", site: "https://www.jalan.net", cancelPage: "https://faq.jalan.net/faq/show/423?site_domain=default", keywords: ["æ—…è¡Œ"], notes: "ä¼šå“¡é€€ä¼šãƒ•ã‚©ãƒ¼ãƒ ã‚ã‚Šã€‚" },
  { id: "rakuten-travel", name: "æ¥½å¤©ãƒˆãƒ©ãƒ™ãƒ«", site: "https://travel.rakuten.co.jp", cancelPage: "https://travel.faq.rakuten.net/detail/000006954", keywords: ["æ—…è¡Œ"], notes: "æ¥½å¤©ä¼šå“¡æƒ…å ±ã‹ã‚‰ã€‚" },
  { id: "ana", name: "ANAãƒã‚¤ãƒ¬ãƒ¼ã‚¸ã‚¯ãƒ©ãƒ–", site: "https://www.ana.co.jp", cancelPage: "https://www.ana.co.jp/ja/jp/mycampaign/faq/members/cancel/", keywords: ["æ—…è¡Œ"], notes: "å•ã„åˆã‚ã›æ‰‹ç¶šãã€‚" },
  { id: "jal", name: "JALãƒã‚¤ãƒ¬ãƒ¼ã‚¸ãƒãƒ³ã‚¯", site: "https://www.jal.co.jp", cancelPage: "https://www.jal.co.jp/jp/ja/jmb/withdrawal/", keywords: ["æ—…è¡Œ"], notes: "é€€ä¼šãƒ•ã‚©ãƒ¼ãƒ ã‚ã‚Šã€‚" }
];

/**
 * ã‚·ãƒ³ãƒ—ãƒ«fetchï¼‹cheerioã§ã‚¿ã‚¤ãƒˆãƒ«æŠ½å‡º
 */
async function checkPage(url) {
  if (!url) return { ok: false, status: 0, title: "" };
  try {
    const res = await fetch(url, { redirect: "follow" });
    const html = await res.text();
    const $ = cheerio.load(html);
    const title = ($("title").text() || "").trim();
    return { ok: res.ok, status: res.status, title };
  } catch {
    return { ok: false, status: 0, title: "" };
  }
}

/**
 * 10ä»¶ãšã¤ä¸¦åˆ—å‡¦ç†ã§é€Ÿåº¦æ”¹å–„
 */
async function main() {
  console.log(`ğŸ” Checking ${targets.length} services...`);
  const chunk = 10;
  const results = [];

  for (let i = 0; i < targets.length; i += chunk) {
    const slice = targets.slice(i, i + chunk);
    const subset = await Promise.all(
      slice.map(async (t) => {
        const info = await checkPage(t.cancelPage);
        if (!t.cancelPage) console.warn(`âš ï¸ No cancelPage for ${t.id}`);
        return {
          ...t,
          status: info.ok ? "ok" : "check",
          title: info.title
        };
      })
    );
    results.push(...subset);
    console.log(`âœ… Processed ${i + subset.length}/${targets.length}`);
  }

  // data/services.json å‡ºåŠ›
  const dataDir = path.join(__dirname, "..", "data");
  fs.mkdirSync(dataDir, { recursive: true });
  fs.writeFileSync(path.join(dataDir, "services.json"), JSON.stringify(results, null, 2));

  // public/data/services.json å‡ºåŠ›ï¼ˆCloudflare Pages ç”¨ï¼‰
  const publicDir = path.join(__dirname, "..", "public", "data");
  fs.mkdirSync(publicDir, { recursive: true });
  fs.writeFileSync(path.join(publicDir, "services.json"), JSON.stringify(results, null, 2));

  console.log(`ğŸ‰ Updated ${results.length} services.`);
}

main().catch((e) => {
  console.error(e);
  process.exit(1);
});
